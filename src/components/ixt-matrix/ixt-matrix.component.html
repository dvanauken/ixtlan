<!-- Add save button above table -->
<div class="ixt-matrix__toolbar">
  <button class="ixt-matrix__save-button" 
          [disabled]="!hasChanges"
          (click)="saveChanges()">
    <span class="material-icons">save</span>
  </button>
 </div>
 
 <ng-container *ngIf="hasData; else noData">
  <div class="ixt-matrix">
    <!-- Header Row -->
    <div class="ixt-matrix__header">
      <div class="ixt-matrix__cell" *ngFor="let col of columns" [class.ixt-matrix__cell--first]="col === columns[0]">
        <div class="ixt-matrix__cell-content">
          {{col}}
          <div class="ixt-matrix__cell-actions">
            <button class="ixt-matrix__sort-toggle" (click)="toggleSort(col)">
              <span class="material-icons">
                {{getSortIcon(col)}}
              </span>
            </button>
            <button class="ixt-matrix__filter-toggle" (click)="toggleFilters(col)">
              <span class="material-icons">filter_alt</span>
            </button>
          </div>
        </div>
      </div>
      <div class="ixt-matrix__cell">Actions</div>
    </div>
 
    <!-- Filter Row -->
    <div class="ixt-matrix__header" *ngIf="showFilters">
      <div class="ixt-matrix__cell" *ngFor="let col of columns" [class.ixt-matrix__cell--first]="col === columns[0]">
        <ng-container *ngIf="activeFilterColumn === col && columnFilters?.[col]">
          <ng-container [ngSwitch]="columnFilters?.[col]?.type">
            <!-- Text Filter -->
            <input *ngSwitchCase="'text'" [formControl]="getFilterControl(col)"
              [placeholder]="columnFilters?.[col]?.placeholder || ''" class="ixt-matrix__filter-input">
 
            <!-- Number Filter -->
            <div *ngSwitchCase="'number'" class="ixt-matrix__number-filter">
              <select [formControl]="getOperatorControl(col)">
                <option value="=">=</option>
                <option value=">">&gt;</option>
                <option value="<">&lt;</option>
                <option value=">=">&ge;</option>
                <option value="<=">&le;</option>
                <option value="!=">!=</option>
              </select>
              <input type="number" [formControl]="getFilterControl(col)"
                [placeholder]="columnFilters?.[col]?.placeholder || ''" class="ixt-matrix__filter-input">
            </div>
 
            <!-- Enum Filter -->
            <div *ngSwitchCase="'enum'">
              <input [formControl]="getFilterControl(col)" [placeholder]="columnFilters?.[col]?.placeholder || ''"
                class="ixt-matrix__filter-input" [matAutocomplete]="auto">
              <mat-autocomplete #auto="matAutocomplete">
                <mat-option *ngFor="let option of columnFilters?.[col]?.enumValues || []" [value]="option.value">
                  {{option.label}}
                </mat-option>
              </mat-autocomplete>
            </div>
          </ng-container>
        </ng-container>
      </div>
    </div>
 
    <!-- Standard Table View -->
    <ng-container *ngIf="!isTree">
      <div class="ixt-matrix__row" *ngFor="let row of paginatedData; let i = index">
        <div class="ixt-matrix__cell" 
             *ngFor="let col of columns" 
             [class.ixt-matrix__cell--first]="col === columns[0]">
 
          <ng-container *ngIf="editingRows.has(i) && columnFilters?.[col]?.editable; else displayValue">
            <ng-container [ngSwitch]="columnFilters?.[col]?.type">
              <!-- Text Input -->
              <input *ngSwitchCase="'text'"
                     type="text"
                     [ngModel]="rowChanges.get(i)?.[col] ?? row[col]"
                     (ngModelChange)="onValueChange(i, col, $event)">
              
              <!-- Number Input -->
              <input *ngSwitchCase="'number'"
                     type="number"
                     [ngModel]="rowChanges.get(i)?.[col] ?? row[col]"
                     (ngModelChange)="onValueChange(i, col, $event)">
              
              <!-- Enum select -->
              <select *ngSwitchCase="'enum'"
                      [ngModel]="rowChanges.get(i)?.[col] ?? row[col]"
                      (ngModelChange)="onValueChange(i, col, $event)">
                <option *ngFor="let opt of columnFilters?.[col]?.enumValues || []" 
                        [ngValue]="opt.value">
                  {{opt.label}}
                </option>
              </select>
            </ng-container>
          </ng-container>
 
          <ng-template #displayValue>
            {{row[col]}}
          </ng-template>
        </div>
        
        <!-- Actions Column -->
        <div class="ixt-matrix__cell">
          <button class="ixt-matrix__action-button"
                  *ngIf="!editingRows.has(i)"
                  (click)="startEditing(i)">
            <span class="material-icons">edit</span>
          </button>
          <button class="ixt-matrix__action-button"
                  *ngIf="editingRows.has(i)"
                  (click)="cancelEditing(i)">
            <span class="material-icons">close</span>
          </button>
        </div>
      </div>
    </ng-container>
 
    <!-- Tree View -->
    <ng-container *ngIf="isTree">
      <ng-container *ngTemplateOutlet="treeTemplate; context: { $implicit: data, level: 0 }">
      </ng-container>
    </ng-container>
  </div>
 </ng-container>
 
 <!-- Tree Template -->
 <ng-template #treeTemplate let-nodes let-level="level">
  <div class="ixt-matrix__row" *ngFor="let node of nodes; let i = index">
    <div class="ixt-matrix__cell" *ngFor="let col of columns" [class.ixt-matrix__cell--first]="col === columns[0]"
      [style.padding-left.px]="col === columns[0] ? level * 16 : null">
      <button *ngIf="hasChildren(node)" class="ixt-matrix__toggle" (click)="toggleNode(i)">
        <i [class.expanded]="isExpanded(i)"></i>
      </button>
      {{node[col]}}
    </div>
  </div>
  <ng-container *ngFor="let node of nodes; let i = index">
    <ng-container *ngIf="hasChildren(node) && isExpanded(i)">
      <ng-container *ngTemplateOutlet="treeTemplate; context: { $implicit: node.children, level: level + 1 }">
      </ng-container>
    </ng-container>
  </ng-container>
 </ng-template>
 
 <ng-template #noData>
  <div class="ixt-matrix__empty">
    No data available
  </div>
 </ng-template>